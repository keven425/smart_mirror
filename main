#!/usr/bin/env python

import sys
import time
from cv.tracking import Tracking
import chrome_app.chrome_message as chrome_message
from tof.tof import Tof


if __name__ == '__main__':

  # set up time of flight sensor
  tof = Tof()
  timing = tof.get_timing()

  # set up computer vision
  tracking = Tracking()
  tracking.detect_face(True)
  tracking.detect_smile(True)

  # main loop
  try:
    while True:
      # if !face_detected and face_tracking.detect_faces():
      detection = tracking.detect()
      if detection['face']:
        chrome_message.send_message('{"action": "face_detected"}\n')

      distance = tof.get_distance() # in mm
      if distance > 0:
        # if far away, tof returns noisy range < 200
        # simply return a large number
        if distance < 200.:
          distance = 999.
        chrome_message.send_message('{"action": "tof_distance", "value": %f}\n' % distance)

      time.sleep(timing / 1000000.00)

  except KeyboardInterrupt:
    tracking._cleanup()
    sys.exit(0)

  # tof.stop_ranging()
  sys.exit(0)
